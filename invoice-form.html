<!DOCTYPE html>
<html>
<head>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: white; }
        .header-flex { display: flex; justify-content: space-between; margin-bottom: 20px; background: #f8f9fa; padding: 10px; border-radius: 5px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #2c3e50; color: white; padding: 10px; border: 1px solid #ddd; }
        td { border: 1px solid #ddd; padding: 8px; }
        input { width: 95%; border: 1px solid #eee; padding: 5px; outline: none; }
        input:focus { border-color: #3498db; }
        .total-box { text-align: right; margin-top: 20px; font-size: 1.5em; font-weight: bold; color: #2e7d32; }
        .btn-gen { background: #27ae60; color: white; padding: 15px; width: 100%; border: none; border-radius: 5px; cursor: pointer; font-size: 1.1em; margin-top: 20px; }
        .btn-gen:hover { background: #219150; }
        .delete-btn { color: red; cursor: pointer; font-weight: bold; border: none; background: none; }
    </style>
</head>
<body>

    <div class="header-flex">
        <div><strong>Invoice ID:</strong> <span id="display-inv-id">--</span></div>
        <div><strong>Date:</strong> <span id="display-date">--</span></div>
    </div>

    <div style="margin-bottom: 20px;">
        <label><strong>Client Name:</strong></label><br>
        <input type="text" id="client-name" placeholder="Enter client name..." style="width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc;">
    </div>

    <table id="invoiceTable">
        <thead>
            <tr>
                <th>Description</th>
                <th width="80">Qty</th>
                <th width="120">Price</th>
                <th width="120">Amount</th>
                <th width="40"></th>
            </tr>
        </thead>
        <tbody id="item-body">
            </tbody>
    </table>

    <div class="total-box">
        Total: <span id="grand-total">0.00</span>
    </div>

    <button class="btn-gen" onclick="submitInvoice()">Generate & Save Invoice</button>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwKgib802NVM4Mn31in9KhfoMHPA9b2tubCMLq7lDrCmthRNyryOiPaAT5FBrnL_qto/exec";
        const user = JSON.parse(localStorage.getItem("user"));
window.onload = async () => {
    document.getElementById("display-date").innerText = new Date().toLocaleDateString();
    addNewRow(); 
    
    const user = JSON.parse(localStorage.getItem("user"));
    if (!user || !user.id) {
        alert("Session expired. Please login again.");
        return;
    }

    // Add &userId= to the URL
    const fetchUrl = `${API_URL}?action=getNextId&userId=${encodeURIComponent(user.id)}`;
    
    try {
        const response = await fetch(fetchUrl);
        const data = await response.json();
        document.getElementById("display-inv-id").innerText = data.nextId;
    } catch (e) {
        console.error("ID Fetch Error:", e);
        document.getElementById("display-inv-id").innerText = "INV-1001";
    }
};
        function addNewRow() {
            const tbody = document.getElementById("item-body");
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td><input type="text" class="row-desc" placeholder="Item name..."></td>
                <td><input type="number" class="row-qty" value="1" oninput="calculate()"></td>
                <td><input type="number" class="row-price" value="0" oninput="calculate()" onblur="checkAutoRow(this)"></td>
                <td class="row-amt" style="text-align:right">0.00</td>
                <td style="text-align:center"><button class="delete-btn" onclick="removeRow(this)">✖</button></td>
            `;
            tbody.appendChild(tr);
        }

        function checkAutoRow(input) {
            const rows = document.querySelectorAll("#item-body tr");
            const lastRow = rows[rows.length - 1];
            // If the user just finished the price on the last row, add a new one
            if (input.parentElement.parentElement === lastRow && input.value > 0) {
                addNewRow();
            }
        }

        function removeRow(btn) {
            const rows = document.querySelectorAll("#item-body tr");
            if (rows.length > 1) {
                btn.parentElement.parentElement.remove();
                calculate();
            }
        }

        function calculate() {
            let grand = 0;
            document.querySelectorAll("#item-body tr").forEach(row => {
                const q = row.querySelector(".row-qty").value || 0;
                const p = row.querySelector(".row-price").value || 0;
                const amt = q * p;
                row.querySelector(".row-amt").innerText = amt.toFixed(2);
                grand += amt;
            });
            document.getElementById("grand-total").innerText = grand.toFixed(2);
        }

      async function submitInvoice() {
    const btn = document.querySelector(".btn-gen");
    const invId = document.getElementById("display-inv-id").innerText;
    const client = document.getElementById("client-name").value;

    if (!client) return alert("Please enter Client Name");

    // 1. DISABLE BUTTON TO PREVENT DOUBLE SAVING
    btn.disabled = true;
    btn.innerText = "Saving... Please wait...";
    btn.style.background = "#ccc";

    const items = [];
    document.querySelectorAll("#item-body tr").forEach(row => {
        const desc = row.querySelector(".row-desc").value;
        if (desc) {
            items.push({
                description: desc,
                qty: row.querySelector(".row-qty").value,
                price: row.querySelector(".row-price").value,
                amount: row.querySelector(".row-amt").innerText
            });
        }
    });

    const payload = {
        action: "saveInvoice",
        invoiceId: invId,
        userId: user.id,
        clientName: client,
        date: document.getElementById("display-date").innerText,
        total: document.getElementById("grand-total").innerText,
        items: items
    };

    try {
        await fetch(API_URL, { method: "POST", mode: "no-cors", body: JSON.stringify(payload) });
        
        alert("✅ Invoice " + invId + " Saved!");
        window.print();
        
        // Refresh page to get a fresh ID for the next invoice
        window.location.reload(); 
    } catch (err) {
        alert("Error saving invoice. Try again.");
        btn.disabled = false;
        btn.innerText = "Generate & Save Invoice";
        btn.style.background = "#27ae60";
    }
}
    </script>
</body>
</html>
