<script>
    const API_URL = "YOUR_INVOICES_API_URL_HERE"; // Ensure this is your NEWEST deployment URL
    const user = JSON.parse(localStorage.getItem("user"));
    let allData = [];

    window.onload = async () => {
        // Set default dates
        const now = new Date();
        const firstDay = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().split('T')[0];
        const today = now.toISOString().split('T')[0];
        document.getElementById("fromDate").value = firstDay;
        document.getElementById("toDate").value = today;
        
        if (!user || !user.id) {
            alert("User not found. Please login.");
            return;
        }

        try {
            const response = await fetch(`${API_URL}?action=getInvoices&userId=${user.id}`);
            const text = await response.text(); // Get raw text first to check for errors
            
            try {
                allData = JSON.parse(text);
                console.log("Data loaded:", allData);
                // Automatically run report for current month on load
                generateReport();
            } catch (e) {
                console.error("Server returned non-JSON response:", text);
                alert("Server Error: Check Console (F12)");
            }
        } catch (err) {
            console.error("Fetch failed:", err);
        }
    };

    function generateReport() {
        const fromVal = document.getElementById("fromDate").value;
        const toVal = document.getElementById("toDate").value;
        
        if (!fromVal || !toVal) return;

        // Convert input values to timestamps for accurate comparison
        const start = new Date(fromVal).setHours(0,0,0,0);
        const end = new Date(toVal).setHours(23,59,59,999);
        
        const tbody = document.getElementById("reportBody");
        let totalRev = 0;
        let count = 0;
        tbody.innerHTML = "";

        allData.forEach(inv => {
            // Ensure we handle the date format from the sheet correctly
            const invDate = new Date(inv.date).getTime();

            if (invDate >= start && invDate <= end) {
                count++;
                totalRev += parseFloat(inv.total || 0);
                
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${inv.date}</td>
                    <td>${inv.invoiceId}</td>
                    <td>${inv.clientName}</td>
                    <td style="text-align:right">${parseFloat(inv.total).toFixed(2)}</td>
                `;
                tbody.appendChild(tr);
            }
        });

        document.getElementById("statCount").innerText = count;
        document.getElementById("statRevenue").innerText = totalRev.toFixed(2);
    }
</script>
