<!DOCTYPE html>
<html>
<head>
    <title>eInvoicer - MultiVendor</title>
    <style>
        body { font-family: sans-serif; display: flex; justify-content: center; padding: 50px; background: #f4f4f4; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); width: 300px; }
        input { width: 100%; padding: 10px; margin: 5px 0; box-sizing: border-box; }
        button { width: 100%; padding: 10px; background: #2e7d32; color: white; border: none; cursor: pointer; margin-top: 10px; }
        .hidden { display: none; }
        .toggle { font-size: 12px; color: blue; cursor: pointer; text-align: center; margin-top: 10px; }
    </style>
</head>
<body>

<div class="card" id="authBox">
    <h2 id="title">eInvoicer Login</h2>
    
    <div id="loginFields">
        <input type="email" id="l_email" placeholder="Email">
        <input type="password" id="l_pass" placeholder="Password">
        <button onclick="doLogin()">Login</button>
        <div class="toggle" onclick="toggleForm()">New user? Sign up</div>
    </div>

    <div id="signupFields" class="hidden">
        <input type="text" id="s_name" placeholder="Full Name">
        <input type="email" id="s_email" placeholder="Email">
        <input type="password" id="s_pass" placeholder="Password">
        <input type="text" id="s_phone" placeholder="Phone">
        <input type="text" id="s_biz" placeholder="Business Name">
        <button onclick="doSignup()">Create Account</button>
        <div class="toggle" onclick="toggleForm()">Back to Login</div>
    </div>
    
    <p id="msg"></p>
</div>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwKgib802NVM4Mn31in9KhfoMHPA9b2tubCMLq7lDrCmthRNyryOiPaAT5FBrnL_qto/exec"; // PASTE YOUR URL HERE
// 1. AUTO-REDIRECT IF ALREADY LOGGED IN
window.onload = () => {
    if (localStorage.getItem("user")) {
        window.location.href = "dashboard.html";
    }
};
function toggleForm() {
    document.getElementById('loginFields').classList.toggle('hidden');
    document.getElementById('signupFields').classList.toggle('hidden');
    document.getElementById('title').innerText = document.getElementById('loginFields').classList.contains('hidden') ? "eInvoicer Signup" : "eInvoicer Login";
}

async function doSignup() {
    const payload = {
        action: "signup",
        name: document.getElementById("s_name").value,
        email: document.getElementById("s_email").value,
        password: document.getElementById("s_pass").value,
        phone: document.getElementById("s_phone").value,
        business: document.getElementById("s_biz").value
    };

    document.getElementById("msg").innerText = "Registering...";
    
    await fetch(API_URL, {
        method: "POST",
        mode: "no-cors",
        body: JSON.stringify(payload)
    });

    document.getElementById("msg").innerText = "✅ Signup request sent. Try logging in now.";
    toggleForm();
}

async function doLogin() {
    const email = document.getElementById("l_email").value;
    const pass = document.getElementById("l_pass").value;
    const msg = document.getElementById("msg");
    msg.innerText = "Authenticating...";

    try {
        const response = await fetch(API_URL, {
            method: "POST",
            headers: {
                "Content-Type": "text/plain" // Using text/plain avoids some CORS triggers
            },
            body: JSON.stringify({ action: "login", email: email, password: pass })
        });
        
        const result = await response.json();
        
        if (result.status === "Success") {
            localStorage.setItem("user", JSON.stringify(result));
            alert("Success! Welcome " + result.name);
          // 2. REDIRECT TO DASHBOARD
            window.location.href = "dashboard.html";
        } else {
            msg.innerText = "❌ Invalid Credentials";
        }
    } catch (error) {
        msg.innerText = "❌ Connection Error. Open Console (F12) to see details.";
        console.error("Fetch Error:", error);
    }
}
</script>
</body>
</html>
